var controlsAdded=0;var controlID=1;var markerCount=1;var locInfoControlAdded=false;var projectID="";var drawnItems=L.geoJson(null,{pointToLayer:function(feature,latlng){return L.marker(latlng,{icon:L.icon(yellowMarkerIcon),title:feature.properties.coordinates,riseOnHover:true});}});var drawControl=new L.Control.Draw({draw:{position:'topleft',circle:false,rectangle:false,polygon:false,polyline:false},edit:{featureGroup:drawnItems,remove:true},marker:{repeatMode:true}});var geocoderOptions={position:'topleft',zoomToResult:false,useMapBounds:true,collapseAfterResult:true,expanded:false,placeholder:'Search places or addresses'};var geocoderControl=new L.esri.Controls.Geosearch(geocoderOptions);geocoderControl.on('results',function(data){var i;for(i=data.results.length-1;i>=0;i--){var geocodedMarker={"type":"Feature","properties":{"projectID":projectID,"id":markerCount,"city":data.results[i].city,"country":data.results[i].country,"region":data.results[i].region,"subregion":data.results[i].subregion},"geometry":{"type":"Point","coordinates":[data.results[i].latlng.lng,data.results[i].latlng.lat]}};console.log(geocodedMarker);drawnItems.addData(geocodedMarker);markerCount++;}});function removeControls(){console.log('controlsAdded = '+controlsAdded);if(controlsAdded==1){controlsAdded=0;drawnItems.clearLayers();map.removeControl(drawControl);geocoderControl.removeFrom(map);}
return true;}
function saveLocations(projID){var locationData=getMarkerGeoJSON();console.log('locationData');console.log(locationData);$.ajax({url:"./assets/php-custom/process-location.php",type:"POST",cache:false,data:{pid:projID,locn:locationData},success:function(data){editLocationFormState="hidden";$("#map-location-details").empty().html(data);$("#map-project-details").load("./assets/php-custom/view-project.php?p="+projID,function(){loadTooltips();});zoomToProjectLocations(projID);if(controlsAdded==1){removeControls();}}});}
var editProjectFormState="hidden";function editProject(projID){if(projID){console.log('edit project '+projID);}else{console.log('edit no project');}
$.ajax({url:"./assets/php-custom/edit-project.php",type:"POST",cache:false,data:{p:projID},success:function(data){console.log('load edit project form');editProjectFormState="shown";console.log('editProjectFormState: '+editProjectFormState);$("#map-project-msg").empty();$("#map-project-details").empty().html(data);loadTooltips();$('#form-edit-project').bootstrapValidator(projectValidatorOptions).on('success.field.bv',function(e,data){if(data.bv.isValid()){data.bv.disableSubmitButtons(false);}});sidebar.open('locations');$('#locations').trigger('showpane');$('#mapTabs a[href=\'#map-project-info\']').tab('show');$('#map-location-details').empty();}});getViewport();zoomToProjectLocations(projID);}
function clearMapLayers(){assetLayerGroup.clearLayers();markerClusters.clearLayers();ctiProjectLocations.clearLayers();map.removeLayer(ctiLayer);}
function addLocations(projID){console.log('Add Project - Locations');console.log('Project ID'+projID);$("#map-location-details").load("./assets/php-custom/add-location.php?p="+projID+"&o=a");loadTooltips();clearMapLayers();if(controlsAdded==0){map.addControl(drawControl);map.addControl(geocoderControl);controlsAdded=1;console.log('controlsAdded = '+controlsAdded);}else{console.log('controlsAdded = '+controlsAdded);}}
var editLocationFormState="hidden";function editLocations(projID){editLocationFormState="shown";console.log('editLocations '+projID);clearMapLayers();var projectArg="?p="+projID;var opArg="";$.getJSON("./assets/PHP-Database-GeoJSON-master/simple_points/cti_points_geojson.php"+projectArg,function(data){drawnItems.addData(data);drawnItems.addTo(map);var projCount=drawnItems.getLayers().length;var projMaxzoom;if(projCount>0){var projectBounds=drawnItems.getBounds();if(projCount<5){projMaxzoom=5;}else{projMaxzoom=10;}
map.fitBounds(projectBounds,{maxZoom:projMaxzoom});getViewport();opArg="o=e";}else{console.log('no locations');opArg="o=a";}
$("#map-location-details").load("./assets/php-custom/add-location.php?p="+projID+"&"+opArg);loadTooltips();$('#mapTabs a[href=\'#map-location-info\']').tab('show');if(controlsAdded==0){map.addControl(drawControl);map.addControl(geocoderControl);controlsAdded=1;console.log('controlsAdded = '+controlsAdded);}else{console.log('controlsAdded = '+controlsAdded);}});}
function saveProject(op,loc){var projData;console.log('op: '+op);console.log('loc: '+loc);if(op=='edit'){console.log('Edit Project - '+op);projData=$('form#form-edit-project').serialize();projectID=$('form#form-edit-project #project-id').val();}else if(op=='add'){console.log('Add Project - '+op);projData=$('form#form-add-project').serialize();projectID=$('form#form-add-project #project-id').val();}else if(op=='del'){console.log('Delete Project - '+op);$('#form-edit-project #process-type').val('d');projData=$('form#form-edit-project').serialize();projectID=$('form#form-edit-project #project-id').val();}
$.ajax({type:"POST",url:"assets/php-custom/process-project.php",data:{proj:projData,locn:loc},success:function(msg){console.log(op+' project - SUCCESS; Locations: '+loc);editProjectFormState="hidden";if(loc==1){$("#map-location-msg").html(msg);$('#mapTabs a[href=\'#map-location-info\']').tab('show');if(op=='edit'){console.log('edit locations');editLocations(projectID);}else if(op=='add'){console.log('add locations');addLocations(projectID);}}else if(loc==0){console.log('save project only');if(op!='del'){console.log('here');$("#map-project-msg").empty().html(msg);$('#map-project-details').empty().load("./assets/php-custom/view-project.php?p="+projectID);$("#projects-add").empty().load("./assets/php-custom/add-project.php",function(){loadTooltips();});sidebar.open('locations');$('#locations').trigger('showpane');$('#mapTabs a[href=\'#map-project-info\']').tab('show');}else{reloadPanes();}}},error:function(){console.log("Edit Project - Save - FAILED");}});}
function reloadPanes(){$('#projects-table tbody#projects-list').empty().load('./assets/php-custom/database-listing.php',function(){console.log('reload project list');loadTooltips();});$('#projects-add').empty().load('./assets/php-custom/add-project.php',function(){$('#form-add-project').bootstrapValidator(projectValidatorOptions).on('success.field.bv',function(e,data){if(data.bv.isValid()){data.bv.disableSubmitButtons(false);}});});$('#map-project-details').empty();editProjectFormState="hidden";sidebar.open('database');$('#database').trigger('showpane');$('#projectsTabs a[href=\'#projects\']').tab('show');$('.leaflet-control-location-info').remove();$('.leaflet-draw.leaflet-bar.leaflet-control #loc-info-save').remove();$('#setPoint').remove();controlID=1;markerCount=1;assetLayerGroup.removeLayer(ctiProjectLayer);markerClusters.removeLayer(ctiProjectLocations);map.addLayer(ctiLayer);getViewport();map.setView(map.getCenter(),4);removeControls();}
function getMarkerGeoJSON(){var output='';drawnItems.eachLayer(function(layer){console.log(layer);layer.feature.geometry.coordinates=[layer.getLatLng().lng,layer.getLatLng().lat];layer.feature.properties.municipality=$('#info-mun-'+layer.feature.properties.id).val();layer.feature.properties.province=$('#info-prov-'+layer.feature.properties.id).val();output+=layer.feature.properties.name+' '+layer.feature.properties.id+' '+layer.feature.geometry.coordinates+' '+layer.feature.properties.municipality+'<br/>';});return JSON.stringify(drawnItems.toGeoJSON());}
function createPoint(e){var layer=e.layer,mLatLng=layer.getLatLng();console.log(e.layerType+' '+mLatLng);var marker={"type":"Feature","properties":{"id":markerCount},"geometry":{"type":"Point","coordinates":[mLatLng.lng,mLatLng.lat]}};var shortLongitude=parseFloat(mLatLng.lat).toFixed(2);var shortLatitude=parseFloat(mLatLng.lng).toFixed(2);layer.bindPopup('<b>Coordinates</b><br/>Latitude: '+shortLatitude+'<br/>Longitude: '+shortLongitude);drawnItems.addData(marker);}
function setLatLng(){var lat=$('input#setLat').val(),lng=$('input#setLng').val();console.log(lat+','+lng);if(drawnItems){if(lat&lng){var marker={"type":"Feature","properties":{"id":markerCount},"geometry":{"type":"Point","coordinates":[lng,lat]}};drawnItems.addData(marker);}}}
function clearLatLng(){$('input#setLat').val("");$('input#setLng').val("");}
function viewProject(projID){console.log('load project info from database listing');getViewport();$('#map-project-msg').empty();$('#map-project-details').empty();$('#map-location-msg').empty();editLocationFormState="hidden";$('#map-location-details').empty();console.log('load view-project.php');$('#map-project-details').empty().load('./assets/php-custom/view-project.php?p='+projID,function(){loadTooltips();});editProjectFormState="hidden";sidebar.open('locations');$('#locations').trigger('showpane');$('#mapTabs a[href=\'#map-project-info\']').tab('show');removeControls();}
map.on('draw:created',function(e){console.log(e.layer);createPoint(e);});map.on('draw:drawstop',function(e){console.log('drawstop');markerCount++;});map.on('draw:deletestop',function(e){$.each(drawnItems._layers,function(index,layer){$('#loc-info-'+layer.feature.properties.id).show();});});drawnItems.on('layerremove',function(e){$('#loc-info-'+e.layer.feature.properties.id).hide();});function focusOnProjectTitleInput(){$('#project-title').focus();}
$('#tab-projects-add').on('shown.bs.tab',focusOnProjectTitleInput);$('#tab-map-project-info').on('shown.bs.tab',focusOnProjectTitleInput);function confirmLeaveEditLocations(){console.log('confirmLeaveEditLocations');if(controlsAdded==1&&editLocationFormState=="shown"){$('#confirm-leave-edit-locations').modal('show');}}
$('#tab-map-project-info').on('show.bs.tab',confirmLeaveEditLocations);$('#tab-map-legend').on('show.bs.tab',confirmLeaveEditLocations);$('#tab-map-filter').on('show.bs.tab',confirmLeaveEditLocations);function confirmLeaveEditProject(e){console.log('confirmLeaveEditProject');console.log(e.type);if(e.type=='click'&&editProjectFormState=='shown'){$('#confirm-leave-edit-project').modal('show');console.log('back from confirm-leave-edit-project modal');}else{console.log('no confirm modal');}}
$('#tab-map-location-info').on('click',confirmLeaveEditProject);$('#tab-map-legend').on('click',confirmLeaveEditProject);$('#tab-map-filter').on('click',confirmLeaveEditProject);$('#tab-projects-list').on('shown.bs.tab',function(e){$('#projects-search').focus();});$('#tab-projects-list').on('click',function(e){$('#projectsTabs a[href=\'#projects\']').tab('show');return false;});function setHeight(pane){console.log(pane);var paneHeight=$(pane).height();console.log('old: '+paneHeight);if(paneHeight+100<200){paneHeight=200;}else{paneHeight+=100;}
console.log('new: '+paneHeight);console.log(sidebar.isOpen());$('#sidebar').css('height',paneHeight);}
$('li#sidebar-li-login').on('click',function(){if($('li#sidebar-li-login').hasClass('active')){$('#sidebar-panes').css({'background-color':'#d0e6f4'});}});$('li#sidebar-li-database').on('click',function(){if($('li#sidebar-li-database').hasClass('active')){$('#sidebar-panes').css('background-color','#ccecc7');}else{$('#sidebar-panes').css('background-color','#ffffff');}});$('#database').bind('showpane',function(){console.log('database shown');$('#sidebar-panes').css('background-color','#ccecc7');});$('li#sidebar-li-map').on('click',function(){if($('li#sidebar-li-map').hasClass('active')){$('#sidebar-panes').css('background-color','#f7e5d7');}else{$('#sidebar-panes').css('background-color','#ffffff');}});$('#locations').bind('showpane',function(){console.log('map shown');$('#sidebar-panes').css('background-color','#f7e5d7');});$('li#sidebar-li-monitor').on('click',function(){if($('li#sidebar-li-monitor').hasClass('active')){$('#sidebar-panes').css('background-color','#f5f0d2');}else{$('#sidebar-panes').css('background-color','#ffffff');}});$('li#sidebar-li-help').on('click',function(){if($('li#sidebar-li-help').hasClass('active')){$('#sidebar-panes').css('background-color','#dddddd');}else{$('#sidebar-panes').css('background-color','#ffffff');}});