var map;var assetLayerGroup=new L.LayerGroup();var sidebar=L.control.sidebar('sidebar').addTo(map);var highlight=L.geoJson(null);var ctiLayer=L.geoJson(null);var ctiProjLayer=L.geoJson(null);var currentProjectLayer=L.geoJson(null);var markerClusters=new L.MarkerClusterGroup({spiderfyOnMaxZoom:true,showCoverageOnHover:false,zoomToBoundsOnClick:true,disableClusteringAtZoom:16});var markerClustersCurrent=new L.MarkerClusterGroup({spiderfyOnMaxZoom:true,showCoverageOnHover:false,zoomToBoundsOnClick:true,disableClusteringAtZoom:16});function onEachLocation(feature,layer){if(feature.properties){var projStart=feature.properties.start;var projEnd=feature.properties.end;var startDate;if(projStart){startDate=projStart.substring(0,10);}else{startDate="";}
var endDate;if(projEnd){endDate=projEnd.substring(0,10);}else{projEnd="";}
var website=feature.properties.website;var websiteLink;if(website){websiteLink="<a href='"+website+"'>"+website+"</a>";}else{websiteLink="";}
var shortLongitude=parseFloat(feature.geometry.coordinates[0]).toFixed(2);var shortLatitude=parseFloat(feature.geometry.coordinates[1]).toFixed(2);var projectTitle=feature.properties.title;var municipality=feature.properties.municipality;var province=feature.properties.province;var city=feature.properties.city;var region=feature.properties.region;var subregion=feature.properties.subregion;var country=feature.properties.country;var countries=feature.properties.countries;var locationInfo="<table class='table table-condensed'>"+"<thead><tr><td colspan='2'><div><h4 class='text-capitalize'>"+projectTitle+"</h4></td></tr></thead>"+"<tbody class='list'>"+"<tr><td class='col-xs-3'><b>Longitude</b></td><td class='col-xs-9'>"+shortLongitude+"</td></tr>"+"<tr><td><b>Latitude</b></td><td>"+shortLatitude+"</td></tr>"+"<tr><td><b>Municipality</b></td><td>"+(municipality==null?'':municipality)+"</td></tr>"+"<tr><td><b>Province</b></td><td>"+(province==null?'':province)+"</td></tr>"+"<tr><td><b>City</b></td><td>"+(city==null?'':city)+"</td></tr>"+"<tr><td><b>Region</b></td><td>"+(region==null?'':region)+"</td></tr>"+"<tr><td><b>Subregion</b></td><td>"+(subregion==null?'':subregion)+"</td></tr>"+"<tr><td><b>Country</b></td><td>"+(country==null?'':country)+"</td></tr>"+"<tr><td><b>Project&nbsp;Countries</b></td><td>"+(countries==null?'':countries)+"</td></tr>"+"</tbody>"+"</table></div>";layer.on({click:function(e){getViewport();console.log('onEachLocation - click');$("#map-project-details").empty();$('#map-project-details').load('./assets/php-custom/view-project.php?p='+feature.properties.ID,function(){loadTooltips();});$("#map-location-details").empty();$("#map-location-msg").empty();$("#map-location-details").append(locationInfo);sidebar.open('locations');$('#locations').trigger('showpane');$("#mapTabs a[href='#map-location-info']").tab('show');highlight.clearLayers().addLayer(L.circleMarker([feature.geometry.coordinates[1],feature.geometry.coordinates[0]],{stroke:false,fillColor:"#000000",fillOpacity:0.7,radius:10}));}});}}
var yellowMarkerIcon={iconUrl:"assets/img/map-pin-yellow.png",iconAnchor:[15,50],popupAnchor:[0,-25]}
var blueMarkerIcon={iconUrl:"assets/img/marker-icon.png",iconAnchor:[12,28],popupAnchor:[0,-25]}
var ctiProjectLayer=L.geoJson(null);var ctiProjectLocations=L.geoJson(null,{pointToLayer:function(feature,latlng){return L.marker(latlng,{icon:L.icon(yellowMarkerIcon),title:feature.properties.coordinates,riseOnHover:true});},onEachFeature:onEachLocation});var ctilocations=L.geoJson(null,{pointToLayer:function(feature,latlng){return L.marker(latlng,{icon:L.icon(yellowMarkerIcon),});},onEachFeature:onEachLocation});function getViewport(){console.log('getViewport');if(sidebar.isOpen()){map.setActiveArea({position:"absolute",top:"0px",left:$("#sidebar").css("width"),right:"0px",height:$("#map").css("height")});}else{map.setActiveArea({position:"absolute",top:"0px",left:"0px",right:"0px",height:$("#map").css("height")});}}
function loadTooltips(){$('[data-toggle="tooltip"]').tooltip({container:'body',trigger:'hover'});}
$(document).ready(function(){loadTooltips();$('[data-toggle=tooltip]').tooltip({container:'body',trigger:'hover'});});function zoomToProjectLocations(projectID){if(document.body.clientWidth<=767){sidebar.hide();getViewport();}
var projectArg="";if(projectID!=null){console.log('zoom to project ID '+projectID);projectArg="?p="+projectID;}else{console.log('zoom to all projects');projectArg="";}
$.getJSON("./assets/PHP-Database-GeoJSON-master/simple_points/cti_points_geojson.php"+projectArg,function(data){ctiProjectLocations.clearLayers();ctiProjectLocations.addData(data);var projCount=ctiProjectLocations.getLayers().length;if(projCount>0){console.log('project '+projectID+' has '+ctiProjectLocations.getLayers().length+' locations');assetLayerGroup.clearLayers();markerClusters.clearLayers();map.removeLayer(ctiLayer);if(controlsAdded==1){drawnItems.clearLayers();}
var projectBounds=ctiProjectLocations.getBounds();var projMaxzoom;if(projCount<5){projMaxzoom=5;}else{projMaxzoom=10;}
console.log('projMaxzoom: '+projMaxzoom);map.fitBounds(projectBounds,{maxZoom:projMaxzoom});var currZoom=map.getZoom();console.log('currZoom'+currZoom);getViewport();}else{console.log('project '+projectID+' has no locations');}
assetLayerGroup.addLayer(ctiProjectLayer);markerClusters.addLayer(ctiProjectLocations);});return true;}
var mapquestOSM=L.tileLayer("http://{s}.mqcdn.com/tiles/1.0.0/osm/{z}/{x}/{y}.png",{maxZoom:19,subdomains:["otile1","otile2","otile3","otile4"],attribution:'Tiles courtesy of <a href="http://www.mapquest.com/" target="_blank">MapQuest</a> <img src="http://developer.mapquest.com/content/osm/mq_logo.png">. Map data (c) <a href="http://www.openstreetmap.org/" target="_blank">OpenStreetMap</a> contributors, CC-BY-SA.'});var mapquestOAM=L.tileLayer("http://{s}.mqcdn.com/tiles/1.0.0/sat/{z}/{x}/{y}.jpg",{maxZoom:18,subdomains:["oatile1","oatile2","oatile3","oatile4"],attribution:'Tiles courtesy of <a href="http://www.mapquest.com/" target="_blank">MapQuest</a>. Portions Courtesy NASA/JPL-Caltech and U.S. Depart. of Agriculture, Farm Service Agency'});var mapquestHYB=L.layerGroup([L.tileLayer("http://{s}.mqcdn.com/tiles/1.0.0/sat/{z}/{x}/{y}.jpg",{maxZoom:18,subdomains:["oatile1","oatile2","oatile3","oatile4"]}),L.tileLayer("http://{s}.mqcdn.com/tiles/1.0.0/hyb/{z}/{x}/{y}.png",{maxZoom:19,subdomains:["oatile1","oatile2","oatile3","oatile4"],attribution:'Labels courtesy of <a href="http://www.mapquest.com/" target="_blank">MapQuest</a> <img src="http://developer.mapquest.com/content/osm/mq_logo.png">. Map data (c) <a href="http://www.openstreetmap.org/" target="_blank">OpenStreetMap</a> contributors, CC-BY-SA. Portions Courtesy NASA/JPL-Caltech and U.S. Depart. of Agriculture, Farm Service Agency'})]);var ctiLayerCoords=[];$.getJSON("./assets/PHP-Database-GeoJSON-master/simple_points/cti_points_geojson.php",function(data){ctilocations.addData(data);map.addLayer(ctiLayer);assetLayerGroup.addLayer(ctiLayer);L.geoJson(data,{onEachFeature:function(feature,layer){ctiLayerCoords.push([feature.geometry.coordinates[1],feature.geometry.coordinates[0]]);}});var bounds=L.latLngBounds(ctiLayerCoords);var center=bounds.getCenter();map.setView(center,4);});var ctiProjects=L.geoJson(null,{onEachFeature:onEachLocation});map=new L.Map("map",{zoom:10,center:[9.622,111.137],layers:[mapquestHYB,markerClusters],zoomControl:true,drawControl:false,attributionControl:false,scrollWheelZoom:true});map.on("overlayadd",function(e){if(e.layer===ctiLayer){markerClusters.addLayer(ctilocations);}
if(e.layer===ctiProjLayer){markerClusters.addLayer(ctiProjects);}});map.on("overlayremove",function(e){if(e.layer===ctiLayer){markerClusters.removeLayer(ctilocations);}
if(e.layer===ctiProjLayer){markerClusters.removeLayer(ctiProjects);}});map.on("click",function(e){highlight.clearLayers();});function updateAttribution(e){$.each(map._layers,function(index,layer){if(layer.getAttribution){$("#attribution").html((layer.getAttribution()));}});}
map.on("layeradd",updateAttribution);map.on("layerremove",updateAttribution);var attributionControl=L.control({position:"bottomright"});attributionControl.onAdd=function(map){var attribDiv=L.DomUtil.create("div","leaflet-control-attribution");attribDiv.innerHTML="Coral Triangle Initiative";return attribDiv;};map.addControl(attributionControl);if(document.body.clientWidth<=767){var isCollapsed=true;}else{var isCollapsed=false;}
var baseLayers={"Satellite + Street":mapquestHYB,"Satellite":mapquestOAM,"Street Map":mapquestOSM};var groupedOverlays={"CTI Locations":{"<i class='fa fa-map-marker'></i>&nbsp;Projects":ctiLayer}};var layerControl=L.control.groupedLayers(baseLayers,groupedOverlays,{collapsed:isCollapsed}).addTo(map);$('#projects-search').on('input',function(){searchTerm=$('#projects-search').val();console.log(searchTerm);$.ajax({url:"./assets/php-custom/database-listing.php",type:"POST",cache:false,data:{s:searchTerm},success:function(data){console.log('load search results');$("#projects-list [data-toggle='tooltip']").tooltip('hide');$("#projects-list").empty().html(data);loadTooltips();}});});$('#projects-search-clear').on('click',function(){$('#projects-search').val('');$('#projects-search').trigger('input');zoomToProjectLocations();});var filterSerialized;$('#form-map-filter').on('change',function(e){filterSerialized=$('#form-map-filter').serialize();applyFilter(filterSerialized);});$('#filter-clear-filter').on('click',function(e){filterSerialized="";applyFilter(filterSerialized);});function applyFilter(filterParams){console.log(filterParams);$.ajax({url:"./assets/php-custom/filter.php",type:"POST",cache:false,data:{f:filterParams},success:function(data){console.log('filtering');clearMapLayers();ctiProjectLocations.addData(data);map.fitBounds(ctiProjectLocations.getBounds(),{maxzoom:15});markerClusters.addLayer(ctiProjectLocations);markerClusters.addTo(map);getViewport();}});}
$('#monitorType').on('change',function(e){var baseurl="./data/monitor/";var script=$('#monitorType :selected').val();url=baseurl+script;$.getScript(url,function(){console.log("Load was performed.");});});function setChartData(chartIndex){console.log(chartIndex);var chartData=["cti-chart-0-number-of-projects-per-goal.js","cti-chart-1-percent-of-projects-per-goal.js","cti-chart-2-number-of-projects-per-country.js","cti-chart-31-number-of-projects-per-goal-RP.js","cti-chart-32-number-of-projects-per-goal-IND.js","cti-chart-33-number-of-projects-per-goal-MAL.js","cti-chart-41-percent-of-projects-per-goal-RP.js","cti-chart-42-percent-of-projects-per-goal-IND.js","cti-chart-43-percent-of-projects-per-goal-MAL.js"];var baseurl="./data/monitor/";var script=chartData[chartIndex];url=baseurl+script;$.getScript(url,function(){console.log("Loaded "+url);});}
$('#selectChart').on('hidden.bs.dropdown',function(){console.log('dropdown hidden');});$('#sidebarCollapse').on('click',function(){sidebar.close();$('#sidebarCollapse').css('display','none');});$('#sidebar .sidebar-tabs li').on('click',function(e){if(e.currentTarget.className=='active'){$('#sidebarCollapse').css('display','block');}else{$('#sidebarCollapse').css('display','none');}});